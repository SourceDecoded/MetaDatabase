{"version":3,"sources":["../../src/sqlite/Database.js"],"names":["edmValidator","Database","options","sqliteDatabase","edm","Error","name","tables","validate","_createTables","forEach","table","find","walkedTables","_walkRelationships","tablesWalked","indexOf","forEachRelationship","relationship","sourceTable","_getTableFromEdm","type","relationships","oneToOne","filter","ofType","oneToMany","push","buildOrder","_getTableBuildOrder","reduce","promise","then","sqliteDatabaseTable","createAsync","Promise","resolve","reverse","dropAsync","Object","keys","map"],"mappings":"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","file":"Database.js","sourcesContent":["import Table from \"./Table\";\nimport EdmValidator from \"./EdmValidator\"\n\nconst edmValidator = new EdmValidator();\n\nexport default class Database {\n    constructor(options = {}) {\n        let sqliteDatabase = options.sqliteDatabase;\n        let edm = options.edm;\n\n        if (sqliteDatabase == null) {\n            throw new Error(\"Database needs to have a sqliteDatabase.\");\n        }\n        if (edm == null) {\n            throw new Error(\"Database needs to have a edm.\");\n        }\n\n        this.name = edm.name;\n        this.edm = edm;\n        this.sqliteDatabase = sqliteDatabase;\n        this.tables = {};\n\n        edmValidator.validate(edm);\n        this._createTables();\n    }\n\n    _createTables() {\n        let options = {\n            sqliteDatabase: this.sqliteDatabase,\n            edm: this.edm\n        };\n\n        this.edm.tables.forEach((table) => {\n            this.tables[table.name] = new Table(table.name, options);\n        });\n    }\n\n    _getTableFromEdm(name) {\n        return this.edm.tables.find((table) => {\n            return table.name = name;\n        });\n    }\n\n    _getTableBuildOrder() {\n        let walkedTables = [];\n\n        this.edm.tables.forEach((table) => {\n            this._walkRelationships(table, walkedTables);\n        });\n\n        return walkedTables;\n    }\n\n    _walkRelationships(table, tablesWalked) {\n        if (tablesWalked.indexOf(table) > -1) {\n            return;\n        }\n\n        let forEachRelationship = (relationship) => {\n            let sourceTable = this._getTableFromEdm(relationship.type);\n            this._walkRelationships(sourceTable, tablesWalked);\n        }\n\n        this.edm.relationships.oneToOne.filter((relationship) => {\n            relationship.ofType === table.name;\n        }).forEach(forEachRelationship);\n\n        this.edm.relationships.oneToMany.filter((relationship) => {\n            relationship.ofType === table.name;\n        }).forEach(forEachRelationship);\n\n        tablesWalked.push(table);\n    }\n\n    createAsync() {\n        let buildOrder = this._getTableBuildOrder();\n\n        return buildOrder.reduce((promise, table) => {\n            return promise.then(() => {\n                let sqliteDatabaseTable = this.tables[table.name];\n                return sqliteDatabaseTable.createAsync();\n            });\n        }, Promise.resolve());\n    }\n\n    dropAsync() {\n        let buildOrder = this._getTableBuildOrder().reverse();\n\n        return buildOrder.reduce((promise, table) => {\n            return promise.then(() => {\n                let sqliteDatabaseTable = this.tables[table.name];\n                return sqliteDatabaseTable.dropAsync();\n            });\n        }, Promise.resolve());\n    }\n\n    getTable(name) {\n        return this.tables[name];\n    }\n\n    getTables() {\n        return Object.keys(this.tables).map((name) => {\n            return this.tables[name];\n        });\n    }\n\n}"]}