{"version":3,"sources":["../../src/sqlite/Database.js"],"names":["Database","options","sqlite","edm","Error","name","tables","_createTables","forEach","table","find","walkedTables","_walkRelationships","tablesWalked","indexOf","forEachRelationship","relationship","sourceTable","_getTableFromEdm","type","relationships","oneToOne","filter","ofType","oneToMany","push","buildOrder","_getTableBuildOrder","reduce","promise","then","sqliteTable","createAsync","Promise","resolve","reverse","dropAsync"],"mappings":"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","file":"Database.js","sourcesContent":["import Table from \"./Table\";\n\nexport default class Database {\n    constructor(options = {}) {\n        let sqlite = options.sqlite;\n        let edm = options.edm;\n\n        if (sqlite == null) {\n            throw new Error(\"Database needs to have a sqlite.\");\n        }\n        if (edm == null) {\n            throw new Error(\"Database needs to have a edm.\");\n        }\n\n        this.name = edm.name;\n        this.edm = edm;\n        this.sqlite = sqlite;\n        this.tables = {};\n\n        this._createTables();\n    }\n\n    _createTables() {\n        let options = {\n            sqlite: this.sqlite,\n            edm: this.edm\n        };\n\n        this.edm.tables.forEach((table) => {\n            this.tables[table.name] = new Table(table.name, options);\n        });\n    }\n\n    _getTableFromEdm(name) {\n        return this.edm.tables.find((table) => {\n            return table.name = name;\n        });\n    }\n\n    _getTableBuildOrder() {\n        let walkedTables = [];\n\n        this.edm.tables.forEach((table) => {\n            this._walkRelationships(table, walkedTables);\n        });\n\n        return walkedTables;\n    }\n\n    _walkRelationships(table, tablesWalked) {\n        if (tablesWalked.indexOf(table) > -1) {\n            return;\n        }\n\n        let forEachRelationship = (relationship) => {\n            let sourceTable = this._getTableFromEdm(relationship.type);\n            this._walkRelationships(sourceTable, tablesWalked);\n        }\n\n        this.edm.relationships.oneToOne.filter((relationship) => {\n            relationship.ofType === table.name;\n        }).forEach(forEachRelationship);\n\n        this.edm.relationships.oneToMany.filter((relationship) => {\n            relationship.ofType === table.name;\n        }).forEach(forEachRelationship);\n\n        tablesWalked.push(table);\n    }\n\n    createAsync() {\n        let buildOrder = this._getTableBuildOrder();\n\n        return buildOrder.reduce((promise, table) => {\n            return promise.then(() => {\n                let sqliteTable = this.tables[table.name];\n                return sqliteTable.createAsync();\n            });\n        }, Promise.resolve());\n    }\n\n    dropAsync() {\n        let buildOrder = this._getTableBuildOrder().reverse();\n\n        return buildOrder.reduce((promise, table) => {\n            return promise.then(() => {\n                let sqliteTable = this.tables[table.name];\n                return sqliteTable.dropAsync();\n            });\n        }, Promise.resolve());\n    }\n\n    getTable(name) {\n        return this.tables[name];\n    }\n\n}"]}