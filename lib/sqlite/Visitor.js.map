{"version":3,"sources":["../../src/sqlite/Visitor.js"],"names":["Visitor","name","edm","table","_getTable","currentNavigationTable","joinClauses","tableTypes","Map","dataConverter","convertString","value","_escape","convertContainsString","convertStartsWithString","convertEndsWithString","convertNumber","toString","convertBoolean","convertDate","getTime","clause","index","indexOf","push","replace","relationship","ofType","type","hasKey","withForeignKey","properties","relationships","sourceRelationships","_getRelationshipsAsSource","targetRelationships","_getRelationshipsAsTarget","forEach","property","hasOne","hasMany","joinClause","_buildLeftJoinStatementFromSource","withOne","_buildLeftJoinStatementFromTarget","filter","oneToOneRelationships","oneToOne","oneToManyRelationships","oneToMany","concat","tables","find","Date","Error","column","children","Array","prototype","slice","call","arguments","result","expression","length","joined","join","visitor","parse","propertyAccessor","namespace","left","right","query","countAlias","queryParts","set","where","orderBy","include","skip","take","columnAliases","makeColumnAliases","part","_sqlizePrimitive","whereExpression","array","map","equalTo","notEqual","columns","tableName","columnName","tableMetaData","propertyData","navigationProperties","propertyTable","currentTableName","_addJoinClause","_getNavigationProperties","_writeTableProperty","newValue","substring","Infinity","apply"],"mappings":"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","file":"Visitor.js","sourcesContent":["import ExpressionVisitor from \"./../query/ExpressionVisitor\";\n\nexport default class Visitor extends ExpressionVisitor {\n    constructor(name, edm) {\n        super();\n        this.name = name;\n        this.edm = edm;\n        this.table = this._getTable(name);\n        this.currentNavigationTable = this.table;\n        this.joinClauses = [];\n        this.tableTypes = new Map();\n\n        this.dataConverter = {\n            convertString: (value) => {\n                return this._escape(value);\n            },\n            convertContainsString: (value) => {\n                return \"'%\" + this._escape(value) + \"%'\";\n            },\n            convertStartsWithString: (value) => {\n                return \"'\" + this._escape(value) + \"%'\";\n            },\n            convertEndsWithString: (value) => {\n                return \"'%\" + this._escape(value) + \"'\";\n            },\n            convertNumber: (value) => {\n                return value.toString();\n            },\n            convertBoolean: (value) => {\n                return value ? 1 : 0;\n            },\n            convertDate: (value) => {\n                return value.getTime();\n            }\n        }\n\n    }\n\n    _addJoinClause(clause) {\n        let index = this.joinClauses.indexOf(clause);\n        if (index === -1) {\n            this.joinClauses.push(clause);\n        }\n    }\n\n    _escape(value) {\n        return `'${value.replace(/'/g, \"''\")}'`;\n    }\n\n    _buildLeftJoinStatementFromSource(relationship) {\n        return `LEFT JOIN ${this._escape(relationship.ofType)} ON ${this._escape(relationship.type)}.${this._escape(relationship.hasKey)} = ${this._escape(relationship.ofType)}.${this._escape(relationship.withForeignKey)}`;\n    }\n\n    _buildLeftJoinStatementFromTarget(relationship) {\n        return `LEFT JOIN ${this._escape(relationship.type)} ON ${this._escape(relationship.ofType)}.${this._escape(relationship.withForeignKey)} = ${this._escape(relationship.type)}.${this._escape(relationship.hasKey)}`;\n    };\n\n    _getNavigationProperties(edm, table) {\n        let properties = {};\n        let relationships = edm.relationships;\n\n        let sourceRelationships = this._getRelationshipsAsSource(table, relationships);\n        let targetRelationships = this._getRelationshipsAsTarget(table, relationships);\n\n        sourceRelationships.forEach((relationship) => {\n            let property;\n\n            if (relationship.hasOne != null) {\n                property = relationship.hasOne;\n            } else {\n                property = relationship.hasMany;\n            }\n\n            properties[property] = {\n                relationship: relationship,\n                table: this._getTable(relationship.ofType),\n                joinClause: this._buildLeftJoinStatementFromSource(relationship)\n            };\n        });\n\n        targetRelationships.forEach((relationship) => {\n            properties[relationship.withOne] = {\n                relationship: relationship,\n                table: this._getTable(relationship.type),\n                joinClause: this._buildLeftJoinStatementFromTarget(relationship)\n            };\n        });\n\n        return properties;\n    }\n\n    _getRelationshipsAsSource(table, relationships) {\n        const filter = (relationship) => {\n            return relationship.type === table.name;\n        };\n\n        const oneToOneRelationships = relationships.oneToOne.filter(filter);\n        const oneToManyRelationships = relationships.oneToMany.filter(filter);\n\n        return oneToOneRelationships.concat(oneToManyRelationships);\n    }\n\n    _getRelationshipsAsTarget(table, relationships) {\n        const filter = (relationship) => {\n            return relationship.ofType === table.name;\n        }\n\n        const oneToOneRelationships = relationships.oneToOne.filter(filter);\n        const oneToManyRelationships = relationships.oneToMany.filter(filter);\n\n        return oneToOneRelationships.concat(oneToManyRelationships);\n    }\n\n    _getTable(name) {\n        return this.edm.tables.find((table) => {\n            return table.name === name;\n        });\n    }\n\n    _sqlizePrimitive(value) {\n        if (typeof value === \"string\") {\n            return this.dataConverter.convertString(value);\n        } else if (typeof value === \"number\") {\n            return this.dataConverter.convertNumber(value);\n        } else if (typeof value === \"boolean\") {\n            return this.dataConverter.convertBoolean(value);\n        } else if (value instanceof Date) {\n            return this.dataConverter.convertDate(value);\n        } else if (value == null) {\n            return \"NULL\";\n        } else {\n            throw new Error(\"Unknown primitive type.\");\n        }\n    }\n\n    _writeTableProperty(table, column) {\n        return this._escape(table) + \".\" + this._escape(column);\n    }\n\n    and() {\n        let children = Array.prototype.slice.call(arguments, 0);\n        let result = [];\n\n        children.forEach((expression, index) => {\n            result.push(expression);\n            if (index !== children.length - 1) {\n                result.push(\" AND \");\n            }\n        });\n\n        let joined = result.join(\"\");\n\n        if (joined === \"\") {\n            return \"\";\n        }\n\n        return \"(\" + joined + \")\";\n    }\n\n    any(property, expression) {\n        let table = property.table;\n        let visitor = new Visitor(table.name, this.edm);\n\n        return visitor.parse(expression);\n    }\n\n    ascending(propertyAccessor) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" ASC\";\n    }\n\n    array(expression) {\n        return expression.value;\n    }\n\n    boolean(expression) {\n        return expression.value;\n    }\n\n    countAsync(left, right) {\n        throw new Error(\"Not yet implemented.\");\n    }\n\n    constant(expression) {\n        return expression.value;\n    }\n\n    createSelectStatementWithCount(query, countAlias) {\n        let queryParts = [];\n        countAlias = countAlias || \"count\";\n\n        this.joinClauses = [];\n        this.tableTypes = new Map();\n\n        this.tableTypes.set(this.table.name, this.table);\n\n        let where = this.parse(query.where);\n        let orderBy = this.parse(query.orderBy);\n        let include = this.parse(query.include);\n\n        if (where && include) {\n            where = where + \" AND \" + include;\n        } else if (!where && include) {\n            where = include;\n        }\n\n        queryParts.push(\n            \"SELECT COUNT(*) AS \\\"\" + countAlias + \"\\\" FROM \" + this._escape(this.table.name),\n            this.joinClauses.join(\" \"),\n            where,\n            orderBy\n        );\n\n        return queryParts.join(\" \");\n    }\n\n    createSelectStatement(query) {\n        let queryParts = [];\n\n        this.joinClauses = [];\n        this.tableTypes = new Map();\n\n        this.tableTypes.set(this.table.name, this.table);\n\n        let where = this.parse(query.where);\n        let orderBy = this.parse(query.orderBy);\n        let include = this.parse(query.include);\n        let skip = this.parse(query.skip);\n        let take = this.parse(query.take);\n        let columnAliases = this.makeColumnAliases(this.tableTypes);\n        let joinClause = this.joinClauses.length > 0 ? this.joinClauses.join(\" \") : \"\";\n\n        if (where && include) {\n            where = where + \" AND \" + include;\n        } else if (!where && include) {\n            where = include;\n        }\n\n        queryParts.push(\n            \"SELECT \" + columnAliases + \" FROM \" + this._escape(this.table.name),\n            joinClause,\n            where,\n            orderBy,\n            take,\n            skip\n        );\n\n        return queryParts.filter((part) => {\n            return part != null && part != \"\";\n        }).join(\" \");\n    };\n\n    date(expression) {\n        return this._sqlizePrimitive(expression.value);\n    }\n\n    descending(propertyAccessor) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" DESC\";\n    }\n\n    endsWith(propertyAccessor, value) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" LIKE \" + this.dataConverter.convertEndsWithString(value);\n    }\n\n    equalTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        if (right === null) {\n            return left + \" IS NULL\";\n        } else {\n            return left + \" = \" + this._sqlizePrimitive(right);\n        }\n    }\n\n    expression(expression) {\n        return expression.value;\n    }\n\n    greaterThan(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" > \" + this._sqlizePrimitive(right);\n    }\n\n    greaterThanOrEqualTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" >= \" + this._sqlizePrimitive(right);\n    }\n\n    include(whereExpression) {\n        return whereExpression;\n    }\n\n    isIn(property, array) {\n        return \"(\" + array.map((value) => {\n            return this.equalTo(property, value);\n        }).join(\" OR \") + \")\";\n    }\n\n    isNotIn(property, array) {\n        return \"(\" + array.map((value) => {\n            return this.notEqual(property, value);\n        }).join(\" AND \") + \")\";\n    }\n\n    lessThan(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" < \" + this._sqlizePrimitive(right);\n    }\n\n    lessThanOrEqualTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" <= \" + this._sqlizePrimitive(right);\n    }\n\n    makeColumnAliases(map) {\n        let columns = [];\n\n        map.forEach((table) => {\n            let tableName = table.name;\n\n            table.columns.forEach((column) => {\n                let columnName = column.name;\n\n                columns.push(this._escape(tableName) + \".\" + this._escape(columnName) + \" AS \" + this._escape(tableName + \"___\" + columnName));\n            });\n\n        });\n\n        return columns.join(\", \");\n    }\n\n    not(left, right) {\n        return left + \" NOT \" + right;\n    }\n\n    notEqualTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        if (right === null) {\n            return left + \" IS NOT NULL\";\n        } else {\n            return left + \" <> \" + this._sqlizePrimitive(right);\n        }\n    }\n\n    null(expression) {\n        return null;\n    }\n\n    number(expression) {\n        return expression.value;\n    }\n\n    or() {\n        let children = Array.prototype.slice.call(arguments, 0);\n        let result = [];\n        children.forEach((expression, index) => {\n            result.push(expression);\n            if (index !== children.length - 1) {\n                result.push(\" OR \");\n            }\n        });\n\n        let joined = result.join(\"\");\n\n        if (joined === \"\") {\n            return \"\";\n        }\n\n        return \"(\" + joined + \")\";\n    }\n\n    orderBy() {\n        let result = Array.prototype.slice.call(arguments, 0).join(\", \");\n        if (!result) {\n            return \"\";\n        }\n\n        return \"ORDER BY \" + result;\n    }\n\n    property(expression) {\n        let property = expression.value;\n        return property;\n    }\n\n    propertyAccess(tableMetaData, property) {\n        let propertyData = tableMetaData.navigationProperties && tableMetaData.navigationProperties[property] || null;\n        let propertyTable = propertyData && propertyData.table || null;\n        let currentTableName = this.currentNavigationTable.name;\n\n        let navigationProperties = null;\n\n        if (propertyTable) {\n            this.tableTypes.set(propertyTable.name, propertyTable);\n            this._addJoinClause(propertyData.joinClause);\n            this.currentNavigationTable = propertyTable;\n            navigationProperties = this._getNavigationProperties(this.edm, propertyTable);\n        }\n\n        return {\n            table: propertyTable,\n            value: this._writeTableProperty(currentTableName, property),\n            navigationProperties: navigationProperties\n        };\n    }\n\n    queryable(property, expression) {\n        let table = property.table;\n        let visitor = new Visitor(table.name, this.edm);\n\n        return visitor.parse(expression);\n    };\n\n    skip(value) {\n        return \"OFFSET \" + value;\n    }\n\n    startsWith(propertyAccessor, value) {\n        let namespace = propertyAccessor.value;\n        let newValue = this._sqlizePrimitive(value);\n        newValue = value.substring(1, value.length - 1);\n\n        return namespace + \" LIKE \" + this.dataConverter.convertStartsWithString(value);\n    }\n\n    string(expression) {\n        return expression.value;\n    }\n\n    substringOf(propertyAccessor, value) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" LIKE \" + this.dataConverter.convertContainsString(value);\n    }\n\n    take(value) {\n        if (value === Infinity) {\n            return \"LIMIT -1\";\n        } else {\n            return \"LIMIT\" + value;\n        }\n    }\n\n    type(type) {\n        this.currentNavigationTable = this.table;\n        let navigationProperties = this._getNavigationProperties(this.edm, this.table)\n\n        return {\n            table: this.table,\n            value: \"\",\n            navigationProperties: navigationProperties\n        };\n    }\n\n    where(expression) {\n        if (!expression) {\n            return \"\";\n        }\n        return \"WHERE \" + this[\"and\"].apply(this, arguments);\n    }\n\n}\n\n\n"]}