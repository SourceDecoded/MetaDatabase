{"version":3,"sources":["../../src/dbDriver/MsSqlDriver.js"],"names":["generateEdmCreateSql","options","edmSchema","edmTable","generateGetEdmsQuery","user","Error","password","server","edmDb","dataSchema","dataDb","_edmPool","ConnectionPool","database","on","e","console","error","_edmPoolPromise","connect","_dataPool","_dataPoolPromise","then","_verifyEdmTableAsync","pool","request","query","result","recordset","edm","getDataDbAsync","mssqlDatabase","schema","getEdmDbAsync","close","Promise","resolve","reject","length","catch","err","_checkEdmDbExistsAsync","exists"],"mappings":"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","file":"MsSqlDriver.js","sourcesContent":["// SqlServerDriver.js\nimport mssql from \"mssql\";\nimport MsSqlDatabase from \"../mssql/Database\";\nimport MsSqlMigrator  from \"../mssql/Migrator\";\n\nlet generateEdmCreateSql = function(options) {\n    return `CREATE TABLE ${options.edmSchema}.${options.edmTable}(\n        [id] [int] IDENTITY(1,1) NOT NULL,\n        [json] [text] NOT NULL,\n        [name] [varchar](100) NOT NULL,\n        [version] [int],\n     CONSTRAINT [PK_edm.edm] PRIMARY KEY CLUSTERED \n    (\n        [id] ASC\n    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]\n    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]`;\n}\n\nlet generateGetEdmsQuery = function(options) {\n    return `SELECT [id], [json], [name], [version] \n    FROM ${options.edmSchema}.${options.edmTable}`;\n}\n\nexport default class {\n\n    constructor(options = {}) {\n        if (!options.user) {\n            throw new Error(\"MsSqlDriver requires a user\");\n        }\n        if (!options.password) {\n            throw new Error(\"MsSqlDriver requires a password\");\n        }\n        if (!options.server) {\n            throw new Error(\"MsSqlDriver requires a server\");\n        }\n\n        options.edmDb = options.edmDb || \"GLASS_edm\";\n        options.edmSchema = options.edmSchema || \"dbo\";\n        options.edmTable = options.edmTable || \"edm\";\n        options.dataSchema = options.dataSchema || \"dbo\";\n        options.dataDb = options.dataDb || \"GLASS_data\";\n\n        this.options = options;\n\n        this._edmPool = new mssql.ConnectionPool({\n            user: options.user,\n            password: options.password,\n            server: options.server,\n            database: options.edmDb\n        });\n        this._edmPool.on(\"error\", (e) => {\n            console.error(e);\n        });\n        this._edmPoolPromise = this._edmPool.connect();\n\n        this._dataPool = new mssql.ConnectionPool({\n            user: options.user,\n            password: options.password,\n            server: options.server,\n            database: options.dataDb\n        });\n        this._dataPool.on(\"error\", (e) => {\n            console.error(e);\n        });\n        this._dataPoolPromise = this._dataPool.connect();\n\n    }\n\n    getEdmDbAsync() {\n        return this._edmPoolPromise.then(() => this._edmPool);\n    }\n\n    getDataDbAsync() {\n        return this._dataPoolPromise.then(() => this._dataPool);\n    }\n\n    getEdmListAsync() {\n        return this._verifyEdmTableAsync().then((pool) => {\n            return pool.request().query(generateGetEdmsQuery(this.options));\n        }).then((result) => {\n            return result.recordset;\n        });\n    }\n\n    getDatabaseForEdmAsync(edm) {\n        return this.getDataDbAsync().then((pool) => {\n            return new MsSqlDatabase({\n                edm: edm,\n                mssqlDatabase: pool,\n                schema: this.options.dataSchema\n            });\n        });\n    }\n\n    getMigrator() {\n        return new MsSqlMigrator();\n    }\n\n    dispose() {\n        this.getEdmDbAsync().then((pool) => {\n            pool.close();\n        });\n        this.getDataDbAsync().then((pool) => {\n            pool.close();\n        });\n    }\n\n    _checkEdmDbExistsAsync(pool) {\n        return new Promise((resolve, reject) => {\n            pool.request().query(`SELECT * FROM INFORMATION_SCHEMA.TABLES \n            WHERE TABLE_SCHEMA = '${this.options.edmSchema}' \n            AND TABLE_NAME = '${this.options.edmTable}'`).then((result) => {\n                if (result.recordset.length === 1) {\n                    resolve(true);\n                } else {\n                    resolve(false);\n                }\n            }).catch((err) => {\n                reject(err);\n            });\n        });\n    }\n\n    _verifyEdmTableAsync() {\n        return this.getEdmDbAsync().then((pool) => {\n            return this._checkEdmDbExistsAsync(pool).then((exists) => {\n                if (exists) {\n                    return pool;\n                } else {\n                    return pool.query(generateEdmCreateSql(this.options)).then(() => {\n                        return pool;\n                    });\n                }\n            });\n        });\n    }\n}"]}