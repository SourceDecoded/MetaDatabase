{"version":3,"sources":["../../src/dbDriver/MsSqlDriver.js"],"names":["generateEdmCreateSql","options","edmSchema","edmTable","generateGetEdmsQuery","user","Error","password","server","edmDb","dataSchema","dataDb","_edmPool","ConnectionPool","database","on","e","console","error","_edmPoolPromise","connect","_dataPool","_dataPoolPromise","then","_verifyEdmTableAsync","pool","request","query","result","recordset","map","JSON","parse","json","name","version","getEdmDbAsync","req","input","label","newEdm","getEdmAsync","edm","Promise","reject","stringify","getDataDbAsync","connectionPool","schema","close","resolve","q","length","catch","err","_checkEdmDbExistsAsync","exists"],"mappings":"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","file":"MsSqlDriver.js","sourcesContent":["// SqlServerDriver.js\nimport mssql from \"mssql\";\nimport MsSqlDatabase from \"../mssql/Database\";\nimport MsSqlMigrator  from \"../mssql/Migrator\";\nimport Edm from \"../edm/Edm\";\n\nlet generateEdmCreateSql = function(options) {\n    return `CREATE TABLE ${options.edmSchema}.${options.edmTable}(\n        [id] [int] IDENTITY(1,1) NOT NULL,\n        [json] [text] NOT NULL,\n        [name] [varchar](100) NOT NULL,\n        [version] [varchar](10),\n     CONSTRAINT [PK_edm.edm] PRIMARY KEY CLUSTERED \n    (\n        [id] ASC\n    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]\n    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]`;\n}\n\nlet generateGetEdmsQuery = function(options) {\n    return `SELECT [id], [json], [name], [version] \n    FROM ${options.edmSchema}.${options.edmTable}`;\n}\n\nexport default class {\n\n    constructor(options = {}) {\n        if (!options.user) {\n            throw new Error(\"MsSqlDriver requires a user\");\n        }\n        if (!options.password) {\n            throw new Error(\"MsSqlDriver requires a password\");\n        }\n        if (!options.server) {\n            throw new Error(\"MsSqlDriver requires a server\");\n        }\n\n        options.edmDb = options.edmDb || \"GLASS_edm\";\n        options.edmSchema = options.edmSchema || \"dbo\";\n        options.edmTable = options.edmTable || \"edm\";\n        options.dataSchema = options.dataSchema || \"dbo\";\n        options.dataDb = options.dataDb || \"GLASS_data\";\n\n        this.options = options;\n\n        this._edmPool = new mssql.ConnectionPool({\n            user: options.user,\n            password: options.password,\n            server: options.server,\n            database: options.edmDb\n        });\n        this._edmPool.on(\"error\", (e) => {\n            console.error(e);\n        });\n        this._edmPoolPromise = this._edmPool.connect();\n\n        this._dataPool = new mssql.ConnectionPool({\n            user: options.user,\n            password: options.password,\n            server: options.server,\n            database: options.dataDb\n        });\n\n        this._dataPool.on(\"error\", (e) => {\n            console.error(e);\n        });\n        this._dataPoolPromise = this._dataPool.connect();\n\n    }\n\n    getEdmDbAsync() {\n        return this._edmPoolPromise.then(() => this._edmPool);\n    }\n\n    getDataDbAsync() {\n        return this._dataPoolPromise.then(() => this._dataPool);\n    }\n\n    getEdmListAsync() {\n        return this._verifyEdmTableAsync().then((pool) => {\n            return pool.request().query(generateGetEdmsQuery(this.options));\n        }).then((result) => {\n            return result.recordset.map((result) => {\n                return JSON.parse(result.json);\n            });\n        });\n    }\n\n    getEdmAsync(name, version) {\n        return this.getEdmDbAsync().then((pool) => {\n            let req = pool.request();\n            req.input(\"name\", name);\n            req.input(\"version\", version);\n            return req.query(`SELECT * FROM [${this.options.edmSchema}].[${this.options.edmTable}] ` +\n                   `WHERE [version]=@version AND [name]=@name`).then((result) => {\n                if (result.recordset[0]) {\n                    return JSON.parse(result.recordset[0].json);\n                } else {\n                    return null;\n                }\n            });\n        });\n    };\n\n    addEdmAsync(name, version, label = \"\") {\n        var newEdm = new Edm();\n        newEdm.name = name;\n        newEdm.version = version;\n        newEdm.label = label;\n        return this.getEdmAsync(name, version).then((edm) => {\n            if (edm) {\n                return Promise.reject(new Error(\"An EDM with that name and version already exists\"));\n            } else {\n                return this.getEdmDbAsync().then((pool) => {\n                    let req = pool.request();\n                    req.input(\"name\", name);\n                    req.input(\"version\", version);\n                    req.input(\"json\", JSON.stringify(newEdm));\n                    return req.query(`INSERT INTO [${this.options.edmSchema}].[${this.options.edmTable}] ` + \n                        `(name, version, json) VALUES (@name, @version, @json)`);\n                });\n            }\n        });\n    };\n\n    updateEdmAsync(newEdm) {\n        return this.getEdmDbAsync().then((pool) => {\n            let req = pool.request();\n            req.input('json', JSON.stringify(newEdm));\n            req.input('name', newEdm.name);\n            req.input('version', newEdm.version);\n            return req.query(`UPDATE [${this.options.edmSchema}].[${this.options.edmTable}] `+\n                `SET [json]=@json WHERE name=@name AND version=@version`);\n        });\n    };\n\n    deleteEdmAsync(name, version) {\n        return this.getEdmDbAsync().then((pool) => {\n            let req = pool.request();\n            req.input('version', version);\n            req.input('name', name);\n            return req.query(`DELETE FROM [${this.options.edmSchema}].[${this.options.edmTable}] ` +\n                `WHERE [version]=@version AND [name]=@name`);\n        });\n    };\n\n    getDatabaseForEdmAsync(edm) {\n        return this.getDataDbAsync().then((pool) => {\n            return new MsSqlDatabase({\n                edm: edm,\n                connectionPool: pool,\n                schema: this.options.dataSchema\n            });\n        });\n    }\n\n    dispose() {\n        this.getEdmDbAsync().then((pool) => {\n            pool.close();\n        });\n        this.getDataDbAsync().then((pool) => {\n            pool.close();\n        });\n    }\n\n    _checkEdmDbExistsAsync(pool) {\n        return new Promise((resolve, reject) => {\n            let q = `SELECT * FROM INFORMATION_SCHEMA.TABLES ` + \n            `WHERE TABLE_SCHEMA = '${this.options.edmSchema}' ` +\n            `AND TABLE_NAME = '${this.options.edmTable}'`;\n            pool.request().query(q).then((result) => {\n                if (result.recordset.length === 1) {\n                    resolve(true);\n                } else {\n                    resolve(false);\n                }\n            }).catch((err) => {\n                reject(err);\n            });\n        });\n    }\n\n    _verifyEdmTableAsync() {\n        return this.getEdmDbAsync().then((pool) => {\n            return this._checkEdmDbExistsAsync(pool).then((exists) => {\n                if (exists) {\n                    return pool;\n                } else {\n                    let q = generateEdmCreateSql(this.options);\n                    return pool.request().query(q).then(() => {\n                        return pool;\n                    });\n                }\n            });\n        });\n    }\n}"]}