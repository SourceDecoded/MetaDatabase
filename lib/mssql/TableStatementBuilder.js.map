{"version":3,"sources":["../../src/mssql/TableStatementBuilder.js"],"names":["defaultRelationships","oneToOne","oneToMany","TableStatementBuilder","table","options","dataTypeMapping","edm","schema","name","query","_getDbTableName","version","replace","_getQualifiedDbTableName","entity","Error","values","columns","filterRelevantColumns","forEach","column","columnName","defaultValue","getDefaultValue","push","_escapeName","toMssqlValue","columnsStatement","join","valuesStatement","map","value","index","length","statement","delta","primaryKeyExpr","primaryKeyValues","columnSet","Object","keys","type","getPrimaryKeys","key","primaryKeysExpr","primaryKeys","primaryKey","sqlDataType","primaryKeyStatment","isPrimaryKey","isAutoIncrement","columnsDefinition","createColumnDefinitionStatement","filter","relationships","indexedColumns","foreignKeyIndexes","getTablesRelationshipsAsTargets","relationship","withForeignKey","getTablesRelationshipsAsSources","indexOf","hasKey","isIndexed","createIndexStatement","tableRelationships","createForeignKeyStatement","ofType","assign","columnDefinitionsStatement","createColumnsDefinitionStatement","foreignKeysStatement","_wrapIfTableExists","foreignKeyNames","foreignKey","concat","keyNames","find","Date","getTime"],"mappings":"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","file":"TableStatementBuilder.js","sourcesContent":["import dataTypeMapping from \"./dataTypeMapping\";\n\nconst defaultRelationships = {\n    oneToOne: [],\n    oneToMany: []\n}\n\nexport default class TableStatementBuilder {\n    constructor(table, options) {\n        this.dataTypeMapping = dataTypeMapping;\n        this.table = table;\n        this.edm = options.edm;\n        this.schema = options.schema;\n    }\n\n    _escapeName(name) {\n        return `[${name}]`;\n    }\n\n    _wrapIfTableExists(table, query) {\n        return `IF NOT (EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES \n            WHERE TABLE_SCHEMA = '${this.schema}' AND TABLE_NAME = '${this._getDbTableName(table.name)}'))\n            BEGIN\n            ${query}\n            END`\n    }\n\n    _getDbTableName(table) {\n        return `${table}__${this.edm.version.replace(/\\./g, \"_\")}`;\n    }\n\n    _getQualifiedDbTableName(table) {\n        return `[${this.schema}].[${this._getDbTableName(table)}]`;\n    }\n\n    getQualifiedDbTableName() {\n        return _getQualifiedDbTableName(table.name);\n    }\n\n    createDropTableStatement() {\n        return `IF OBJECT_ID('${this.schema}.${this._getDbTableName(this.table.name)}', 'U') IS NOT NULL DROP TABLE ${this._getQualifiedDbTableName(this.table.name)};`\n    }\n\n    createInsertStatement(entity) {\n        if (entity == null) {\n            throw new Error(\"Null Argument Exception: entity cannot be null or undefined.\");\n        }\n\n        const values = [];\n        const columns = [];\n\n        this.filterRelevantColumns(this.table.columns).forEach((column) => {\n            var columnName = column.name;\n            var defaultValue = this.getDefaultValue(column);\n\n            if (typeof entity[columnName] !== \"undefined\" && entity[columnName] !== null) {\n                columns.push(this._escapeName(columnName));\n\n                if (entity[columnName] === null) {\n                    values.push(this.toMssqlValue(defaultValue));\n                } else {\n                    values.push(this.toMssqlValue(entity[columnName]));\n                }\n            }\n        });\n\n        const columnsStatement = columns.join(\",\");\n\n        const valuesStatement = values.map((value, index) => {\n            return \"@v\"+index;\n        });\n\n        if (values.length === 0) {\n            return {\n                statement: `INSERT INTO ${this._getQualifiedDbTableName(this.table.name)} () VALUES (); SELECT SCOPE_IDENTITY() AS id;`,\n                values: values\n            };\n        }\n\n        return {\n            statement: `INSERT INTO ${this._getQualifiedDbTableName(this.table.name)} (${columnsStatement}) VALUES (${valuesStatement}); SELECT SCOPE_IDENTITY() AS id;`,\n            values: values\n        };\n\n    }\n\n    createUpdateStatement(entity, delta) {\n        let values = [];\n        const primaryKeyExpr = [];\n        const primaryKeyValues = [];\n        const columnSet = [];\n        const columns = this.table.columns;\n\n        if (entity == null) {\n            throw new Error(\"Null Argument Exception: entity cannot be null or undefined.\");\n        }\n\n        if (delta == null) {\n            throw new Error(\"Null Argument Exception: delta cannot be null or undefined.\");\n        }\n\n        if (Object.keys(delta).length === 0) {\n            throw new Error(\"Invalid Argument: delta cannot an empty object.\");\n        }\n\n        this.filterRelevantColumns(columns).forEach((column, index) => {\n            var columnName = column.name;\n\n            if (typeof delta[columnName] !== \"undefined\" && this.dataTypeMapping[column.type] != null) {\n                columnSet.push(this._escapeName(columnName) + `=@v${index}`);\n                values.push(this.toMssqlValue(delta[columnName]));\n            }\n        });\n\n        this.getPrimaryKeys(columns).forEach((key, index) => {\n            primaryKeyExpr.push(this._escapeName(key) + `=@k${index}`);\n            primaryKeyValues.push(entity[key]);\n        });\n\n        return {\n            statement: `UPDATE ${this._getQualifiedDbTableName(this.table.name)} SET ${columnSet.join(\", \")} WHERE ${primaryKeyExpr.join(\" AND \")}`,\n            values: values,\n            keys: primaryKeyValues\n        };\n    }\n\n    createDeleteStatement(entity) {\n        if (entity == null) {\n            throw new Error(\"Null Argument Exception: entity cannot be null or undefined.\");\n        }\n\n        const primaryKeysExpr = [];\n        const values = [];\n        const primaryKeys = this.getPrimaryKeys(this.table.columns);\n\n        primaryKeys.forEach((primaryKey, index) => {\n\n            if (entity[primaryKey] === null) {\n                primaryKeysExpr.push(this._escapeName(primaryKey) + \" IS NULL\");\n            } else {\n                primaryKeysExpr.push(this._escapeName(primaryKey) + \" @k\"+index);\n                values.push(this.toMssqlValue(entity[primaryKey]));\n            }\n\n        });\n\n        return {\n            statement: `DELETE FROM ${this._getQualifiedDbTableName(this.table.name)} WHERE ${primaryKeysExpr.join(\" AND \")}`,\n            keys: values\n        };\n    }\n\n    createColumnDefinitionStatement(column) {\n        const sqlDataType = this.dataTypeMapping[column.type];\n        const primaryKeyStatment = \"\";\n        const primaryKeys = this.getPrimaryKeys(this.table.columns);\n\n        if (sqlDataType != null) {\n            let primaryKey = \"\";\n\n            if (column.isPrimaryKey) {\n\n                if (primaryKeys.length === 1) {\n                    primaryKey = \" PRIMARY KEY\";\n                }\n\n                if (column.isAutoIncrement) {\n                    primaryKey += \" IDENTITY(1,1)\";\n                }\n            }\n\n            return `${this._escapeName(column.name)} ${this.dataTypeMapping[column.type] + primaryKey}`\n\n        } else {\n            return null;\n        }\n    }\n\n    createColumnsDefinitionStatement() {\n        const columns = this.table.columns || [];\n        const columnsDefinition = columns.map((column) => {\n            return this.createColumnDefinitionStatement(column);\n        }).filter((value) => {\n            return value != null;\n        }).join(\", \")\n\n        return columnsDefinition;\n    }\n\n    createIndexStatement(column) {\n        return `IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'${this._getQualifiedDbTableName(this.table.name)}') AND name = N'index_${column.replace(/\\\"/g, '\"\"')}')\n                  CREATE INDEX index_${column.replace(/\\\"/g, '\"\"')} ON ${this._getQualifiedDbTableName(this.table.name)} (${this._escapeName(column)})`;\n    }\n\n    createTableIndexesStatements(relationships) {\n        if (relationships == null) {\n            throw new Error(\"Null Argument Exception: relationships cannot be null or undefined.\");\n        }\n\n        const indexedColumns = {};\n\n        const foreignKeyIndexes = this.getTablesRelationshipsAsTargets(relationships).forEach((relationship) => {\n            indexedColumns[relationship.withForeignKey] = true;\n        });\n\n        const primaryKeys = this.getPrimaryKeys(this.table.columns);\n\n        this.getTablesRelationshipsAsSources(relationships).filter((relationship) => {\n            return primaryKeys.indexOf(relationship.hasKey) === -1;\n        }).forEach((relationship) => {\n            return indexedColumns[relationship.hasKey] = true;\n        });\n\n        primaryKeys.forEach((name) => {\n            indexedColumns[name] = true;\n        });\n\n        this.table.columns.filter((column) => {\n            return column.isIndexed;\n        }).map((column) => {\n            return indexedColumns[column.name]\n        });\n\n        return Object.keys(indexedColumns).map((columnName) => {\n            return this.createIndexStatement(columnName);\n        });\n\n    }\n\n    createForeignKeysStatement(relationships) {\n        const tableRelationships = this.getTablesRelationshipsAsTargets(relationships);\n\n        return tableRelationships.map((relationship) => {\n            return this.createForeignKeyStatement(relationship);\n        }).join(\"/n/t\");\n    }\n\n    createForeignKeyStatement(relationship) {\n        return `CONSTRAINT [c_${relationship.ofType}.${this._getDbTableName(relationship.withForeignKey)}_to_${this._getDbTableName(relationship.type)}.${relationship.hasKey}] FOREIGN KEY([${this._getDbTableName(relationship.withForeignKey)}]) REFERENCES ${this._getQualifiedDbTableName(relationship.type)} ([${relationship.hasKey}])`;\n    }\n\n    createPrimaryKeyStatement() {\n        const primaryKeys = this.getPrimaryKeys(this.table.columns).map((primaryKey) => {\n            return this._escapeName(primaryKey);\n        });\n\n        if (primaryKeys.length === 0) {\n            return \"\";\n        } else {\n            return `PRIMARY KEY (${primaryKeys.join(\", \")})`;\n        }\n    }\n\n    createTableStatement(relationships = {}) {\n        relationships = Object.assign({}, defaultRelationships, relationships);\n\n\n        const columnDefinitionsStatement = this.createColumnsDefinitionStatement();\n        //const foreignKeysStatement = this.createForeignKeysStatement(relationships);\n        // not sure we want to be enforcing these in the DB.\n        const foreignKeysStatement = \"\";\n\n        if (columnDefinitionsStatement && foreignKeysStatement) {\n            return this._wrapIfTableExists(this.table,\n                `CREATE TABLE ${this._getQualifiedDbTableName(this.table.name)} (${columnDefinitionsStatement}, ${foreignKeysStatement})`);\n        } else if (columnDefinitionsStatement) {\n            return this._wrapIfTableExists(this.table,\n                `CREATE TABLE ${this._getQualifiedDbTableName(this.table.name)} (${columnDefinitionsStatement})`);\n        } else {\n            return this._wrapIfTableExists(this.table,\n                `CREATE TABLE ${this._getQualifiedDbTableName(this.table.name)}`);\n        }\n\n    }\n\n    filterRelevantColumns(columns) {\n        return columns.filter((column) => {\n            return this.dataTypeMapping[column.type] != null;\n        });\n    }\n\n    getTablesRelationshipsAsTargets(relationships) {\n        const foreignKeyNames = {};\n\n        const filter = (relationship) => {\n            const foreignKey = relationship.withForeignKey;\n\n            if (relationship.ofType === this.table.name && foreignKeyNames[foreignKey] == null) {\n                foreignKeyNames[foreignKey];\n                return true;\n            }\n            return false;\n        }\n\n        const oneToOne = relationships.oneToOne.filter(filter);\n        const oneToMany = relationships.oneToMany.filter(filter);\n\n        return oneToOne.concat(oneToMany);\n    }\n\n    getTablesRelationshipsAsSources(relationships) {\n        const keyNames = {};\n\n        const filter = (relationship) => {\n            const key = relationship.hasKey;\n\n            if (relationship.type === this.table.name && keyNames[key] == null) {\n                keyNames[key];\n                return true;\n            }\n            return false;\n        }\n\n        const oneToOne = relationships.oneToOne.filter(filter);\n        const oneToMany = relationships.oneToMany.filter(filter);\n\n        return oneToOne.concat(oneToMany);\n    }\n\n    getColumn(name) {\n        return this.table.columns.find((column) => {\n            return column.name === name;\n        });\n    }\n\n    getDefaultValue(column) {\n        return column[`default${column.type}Value`] || null;\n    }\n\n    getPrimaryKeys(columns) {\n        return columns.filter((column) => {\n            return column.isPrimaryKey;\n        }).map((column) => {\n            return column.name;\n        });\n    }\n\n    // TODO: update for MSSQL\n    toMssqlValue(value) {\n        if (typeof value === \"string\") {\n            return value;\n        } else if (typeof value === \"number\") {\n            return value;\n        } else if (typeof value === \"boolean\") {\n            return value ? 1 : 0;\n        } else if (value instanceof Date) {\n            return value.getTime();\n        } else if (value == null) {\n            return null;\n        } else {\n            throw new Error(\"Unknown value.\");\n        }\n    }\n\n}"]}