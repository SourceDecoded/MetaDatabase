{"version":3,"sources":["../../src/mssql/Visitor.js"],"names":["Visitor","name","edm","schema","table","_getTable","value","_escape","toString","getTime","replace","_getDbTableName","tables","find","version","dataConverter","convertString","convertNumber","convertBoolean","Date","convertDate","Error","column","children","Array","from","arguments","result","join","length","expression","array","isArray","map","_sqlizePrimitive","left","_convertContainsString","right","_convertEndsWithString","results","property","type","_writeTableProperty","query","queryBuilder","QueryBuilder","createStatement","_convertStartsWithString","apply"],"mappings":"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","file":"Visitor.js","sourcesContent":["import { ExpressionVisitor } from \"queryablejs\";\n\nexport default class Visitor extends ExpressionVisitor {\n    constructor(name, edm, schema) {\n        super();\n        this.name = name;\n        this.edm = edm;\n        this.table = this._getTable(name);\n        this.schema = schema;\n\n    }\n\n    _convertString(value) {\n        return `'${this._escape(value)}'`;\n    }\n\n    _convertContainsString(value) {\n        return `'%${this._escape(value)}%'`;\n    }\n\n    _convertStartsWithString(value) {\n        return `'${this._escape(value)}%'`;\n    }\n\n    _convertEndsWithString(value) {\n        return `'%${this._escape(value)}'`;\n    }\n\n    _convertNumber(value) {\n        return value.toString();\n    }\n\n    _convertBoolean(value) {\n        return value ? 1 : 0;\n    }\n\n    _convertDate(value) {\n        return value.getTime();\n    }\n\n    _escape(value) {\n        return `${value.replace(/'/g, \"''\")}`;\n    }\n\n    _escapeIdentifier(value) {\n        if (value == null) {\n            return value;\n        }\n\n        return `[${value}]`;\n    }\n\n    _getQualifiedDbTableName() {\n        return `[${this.schema}].[${this._getDbTableName(this.table.name)}]`;\n    }\n\n    _getTable(name) {\n        return this.edm.tables.find((table) => {\n            return table.name === name;\n        });\n    }\n\n    _getDbTableName(table) {\n        return `${table}__${this.edm.version.replace(/\\./g, \"_\")}`;\n    }\n\n    _sqlizePrimitive(value) {\n        if (typeof value === \"string\") {\n            return this.dataConverter.convertString(value);\n        } else if (typeof value === \"number\") {\n            return this.dataConverter.convertNumber(value);\n        } else if (typeof value === \"boolean\") {\n            return this.dataConverter.convertBoolean(value);\n        } else if (value instanceof Date) {\n            return this.dataConverter.convertDate(value);\n        } else if (value == null) {\n            return \"NULL\";\n        } else {\n            throw new Error(\"Unknown primitive type.\");\n        }\n    }\n\n    _writeTableProperty(table, column) {\n        return `[${this.schema}].[${table}__${this.edm.version.replace(/\\./g, \"_\")}].[${column}]`;\n    }\n\n    and() {\n        let children = Array.from(arguments);\n        let result = children.join(\" AND \");\n\n        if (result.length === 0) {\n            return \"\";\n        }\n\n        if (children.length === 1) {\n            return result;\n        }\n\n        return `(${result})`;\n    }\n\n    array(expression) {\n        let array = expression.value;\n\n        if (!Array.isArray(array)) {\n            throw new Error(\"Invalid query: The array value node needs to be an array.\");\n        }\n\n        let result = array.map((value) => {\n            return this._sqlizePrimitive(value);\n        }).join(\", \");\n\n        return `(${result})`;\n    }\n\n    boolean(expression) {\n        return expression.value;\n    }\n\n    constant(expression) {\n        return expression.value;\n    }\n\n    contains(left, value) {\n        return `${left} LIKE ${this._convertContainsString(value)}`;\n    }\n\n    date(expression) {\n        return expression.value;\n    }\n\n    endsWith(left, right) {\n        return `${left} LIKE ${this._convertEndsWithString(right)}`;\n    }\n\n    isEqualTo(left, right) {\n        if (right === null) {\n            return `${left} IS NULL`;\n        } else {\n            return `${left} = ${this._sqlizePrimitive(right)}`;\n        }\n    }\n\n    expression(expression) {\n        return expression.value;\n    }\n\n    isGreaterThan(left, right) {\n        return `${left} > ${this._sqlizePrimitive(right)}`;\n    }\n\n    isGreaterThanOrEqualTo(left, right) {\n        return `${left} >= ${this._sqlizePrimitive(right)}`;\n    }\n\n    isIn(left, results) {\n        return `${left} IN ${results}`;\n    }\n\n    isNotIn(left, results) {\n        return `${left} NOT IN ${results}`;\n    }\n\n    isLessThan(left, right) {\n        return `${left} < ${this._sqlizePrimitive(right)}`;\n    }\n\n    isLessThanOrEqualTo(left, right) {\n        return `${left} <= ${this._sqlizePrimitive(right)}`;\n    }\n\n    not(left, right) {\n        return `${left} NOT ${right}`;\n    }\n\n    isNotEqualTo(left, right) {\n        if (right === \"NULL\") {\n            return `${left} IS NOT NULL`;\n        } else {\n            return `${left} <> ${this._sqlizePrimitive(right)}`;\n        }\n    }\n\n    null(expression) {\n        return expression.value;\n    }\n\n    number(expression) {\n        return expression.value;\n    }\n\n    or() {\n        let children = Array.from(arguments);\n        let result = children.join(\" OR \");\n\n        if (result === \"\") {\n            return \"\";\n        }\n\n        if (children.length === 1) {\n            return result;\n        }\n\n        return `(${result})`;\n    }\n\n    property(expression) {\n        let property = expression.value;\n        return property;\n    }\n\n    propertyAccess(type, property) {\n        return this._writeTableProperty(this.table.name, property);\n    }\n\n    queryable(expression) {\n        let query = expression.value;\n        let queryBuilder = new QueryBuilder(this.edm);\n\n        return `(${queryBuilder.createStatement(query)})`;\n    };\n\n    startsWith(left, value) {\n        return `${left} LIKE ${this._convertStartsWithString(value)}`;\n    }\n\n    string(expression) {\n        return expression.value;\n    }\n\n    type(expression) {\n        return expression.value;\n    }\n\n    where(expression) {\n        if (!expression) {\n            return \"\";\n        }\n\n        return `WHERE ${this[\"and\"].apply(this, arguments)}`;\n    }\n\n}\n"]}