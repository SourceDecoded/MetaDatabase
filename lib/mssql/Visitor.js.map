{"version":3,"sources":["../../src/mssql/Visitor.js"],"names":["Visitor","name","edm","schema","table","_getTable","currentNavigationTable","joinClauses","tableTypes","Map","isParsingInclude","dataConverter","convertString","value","_escape","convertContainsString","convertStartsWithString","convertEndsWithString","convertNumber","toString","convertBoolean","convertDate","getTime","version","replace","_getDbTableName","clause","index","indexOf","push","relationship","ofType","type","hasKey","withForeignKey","properties","relationships","sourceRelationships","_getRelationshipsAsSource","targetRelationships","_getRelationshipsAsTarget","forEach","property","hasOne","hasMany","joinClause","_buildLeftJoinStatementFromSource","withOne","_buildLeftJoinStatementFromTarget","filter","oneToOneRelationships","oneToOne","oneToManyRelationships","oneToMany","concat","tables","find","Date","Error","column","children","Array","prototype","slice","call","arguments","result","expression","length","joined","join","visitor","vistor","parse","propertyAccessor","namespace","left","right","query","countAlias","queryParts","set","where","_escapeIdentifier","orderBy","skip","take","include","columnAliases","makeColumnAliases","_getQualifiedDbTableName","part","_sqlizePrimitive","whereExpression","array","map","equalTo","notEqual","columns","tableName","columnName","tableMetaData","propertyData","navigationProperties","propertyTable","currentTableName","_addJoinClause","_getNavigationProperties","_writeTableProperty","newValue","substring","Infinity","apply"],"mappings":"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","file":"Visitor.js","sourcesContent":["import { ExpressionVisitor } from \"queryablejs\";\n\nexport default class Visitor extends ExpressionVisitor {\n    constructor(name, edm, schema) {\n        super();\n        this.name = name;\n        this.edm = edm;\n        this.table = this._getTable(name);\n        this.currentNavigationTable = this.table;\n        this.joinClauses = [];\n        this.tableTypes = new Map();\n        this.isParsingInclude = false;\n        this.schema = schema;\n\n        this.dataConverter = {\n            convertString: (value) => {\n                return `'${this._escape(value)}'`;\n            },\n            convertContainsString: (value) => {\n                return `'%${this._escape(value)}%'`;\n            },\n            convertStartsWithString: (value) => {\n                return `'${this._escape(value)}%'`;\n            },\n            convertEndsWithString: (value) => {\n                return `'%${this._escape(value)}'`;\n            },\n            convertNumber: (value) => {\n                return value.toString();\n            },\n            convertBoolean: (value) => {\n                return value ? 1 : 0;\n            },\n            convertDate: (value) => {\n                return value.getTime();\n            }\n        }\n\n    }\n\n    _getDbTableName(table) {\n        return `${table}__${this.edm.version.replace(/\\./g, \"_\")}`;\n    }\n\n    _getQualifiedDbTableName() {\n        return `[${this.schema}].[${this._getDbTableName(this.table.name)}]`;\n    }\n\n    _addJoinClause(clause) {\n        let index = this.joinClauses.indexOf(clause);\n        if (index === -1) {\n            this.joinClauses.push(clause);\n        }\n    }\n\n    _escape(value) {\n        return `${value.replace(/'/g, \"''\")}`;\n    }\n\n    _escapeIdentifier(value) {\n        return `[${value}]`;\n    }\n\n    _buildLeftJoinStatementFromSource(relationship) {\n        return `LEFT JOIN [${this.schema}].[${relationship.ofType}] ON [${this.schema}].[${relationship.type}].[${relationship.hasKey}] = [${this.schema}].[${relationship.ofType}].[${relationship.withForeignKey}]`;\n    }\n\n    _buildLeftJoinStatementFromTarget(relationship) {\n        return `LEFT JOIN [${this.schema}].[${relationship.type}] ON [${this.schema}].[${relationship.ofType}].[${relationship.withForeignKey}] = [${this.schema}].[${relationship.type}].[${relationship.hasKey}]`;\n    };\n\n    _getNavigationProperties(edm, table) {\n        let properties = {};\n        let relationships = edm.relationships;\n\n        let sourceRelationships = this._getRelationshipsAsSource(table, relationships);\n        let targetRelationships = this._getRelationshipsAsTarget(table, relationships);\n\n        sourceRelationships.forEach((relationship) => {\n            let property;\n\n            if (relationship.hasOne != null) {\n                property = relationship.hasOne;\n            } else {\n                property = relationship.hasMany;\n            }\n\n            properties[property] = {\n                relationship: relationship,\n                table: this._getTable(relationship.ofType),\n                joinClause: this._buildLeftJoinStatementFromSource(relationship)\n            };\n        });\n\n        targetRelationships.forEach((relationship) => {\n            properties[relationship.withOne] = {\n                relationship: relationship,\n                table: this._getTable(relationship.type),\n                joinClause: this._buildLeftJoinStatementFromTarget(relationship)\n            };\n        });\n\n        return properties;\n    }\n\n    _getRelationshipsAsSource(table, relationships) {\n        const filter = (relationship) => {\n            return relationship.type === table.name;\n        };\n\n        const oneToOneRelationships = relationships.oneToOne.filter(filter);\n        const oneToManyRelationships = relationships.oneToMany.filter(filter);\n\n        return oneToOneRelationships.concat(oneToManyRelationships);\n    }\n\n    _getRelationshipsAsTarget(table, relationships) {\n        const filter = (relationship) => {\n            return relationship.ofType === table.name;\n        }\n\n        const oneToOneRelationships = relationships.oneToOne.filter(filter);\n        const oneToManyRelationships = relationships.oneToMany.filter(filter);\n\n        return oneToOneRelationships.concat(oneToManyRelationships);\n    }\n\n    _getTable(name) {\n        return this.edm.tables.find((table) => {\n            return table.name === name;\n        });\n    }\n\n    _sqlizePrimitive(value) {\n        if (typeof value === \"string\") {\n            return this.dataConverter.convertString(value);\n        } else if (typeof value === \"number\") {\n            return this.dataConverter.convertNumber(value);\n        } else if (typeof value === \"boolean\") {\n            return this.dataConverter.convertBoolean(value);\n        } else if (value instanceof Date) {\n            return this.dataConverter.convertDate(value);\n        } else if (value == null) {\n            return \"NULL\";\n        } else {\n            throw new Error(\"Unknown primitive type.\");\n        }\n    }\n\n    _writeTableProperty(table, column) {\n        return `[${this.schema}].[${table}__${this.edm.version.replace(/\\./g, \"_\")}].[${column}]`;\n    }\n\n    and() {\n        let children = Array.prototype.slice.call(arguments, 0);\n        let result = [];\n\n        children.forEach((expression, index) => {\n            result.push(expression);\n            if (index !== children.length - 1) {\n                result.push(\" AND \");\n            }\n        });\n\n        let joined = result.join(\"\");\n\n        if (joined === \"\") {\n            return \"\";\n        }\n\n        return \"(\" + joined + \")\";\n    }\n\n    any(property, expression) {\n        let table = property.table;\n        let visitor = new Visitor(table.name, this.edm);\n        let result = vistor.parse(expression);\n\n        return visitor.parse(expression);\n    }\n\n    ascending(propertyAccessor) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" ASC\";\n    }\n\n    array(expression) {\n        return expression.value;\n    }\n\n    boolean(expression) {\n        return expression.value;\n    }\n\n    countAsync(left, right) {\n        throw new Error(\"Not yet implemented.\");\n    }\n\n    constant(expression) {\n        return expression.value;\n    }\n\n    createSelectStatementWithCount(query, countAlias) {\n        let queryParts = [];\n        countAlias = countAlias || \"count\";\n\n        this.joinClauses = [];\n        this.tableTypes = new Map();\n\n        this.tableTypes.set(this.table.name, this.table);\n\n        let where = this.parse(query.where);\n\n        queryParts.push(\n            \"SELECT COUNT(*) AS \\\"\" + countAlias + \"\\\" FROM \" + this._escapeIdentifier(this.schema + \".\" + this.table.name),\n            this.joinClauses.join(\" \"),\n            where\n        );\n\n        return queryParts.join(\" \");\n    }\n\n    createCustomSelectStatement(query, properties){\n        \n    }\n\n    createSelectStatement(query) {\n        let queryParts = [];\n\n        this.joinClauses = [];\n        this.tableTypes = new Map();\n\n        this.tableTypes.set(this.table.name, this.table);\n\n        let where = this.parse(query.where);\n        let orderBy = this.parse(query.orderBy);\n        let skip = this.parse(query.skip);\n        let take = this.parse(query.take);\n        \n        this.isParsingInclude = true;\n        let include = this.parse(query.include);\n        this.isParsingInclude = false;\n        \n        let columnAliases = this.makeColumnAliases(this.tableTypes);\n        let joinClause = this.joinClauses.length > 0 ? this.joinClauses.join(\" \") : \"\";\n\n        if (where && include) {\n            where = where + \" AND \" + include;\n        } else if (!where && include) {\n            where = include;\n        }\n\n        queryParts.push(\n            \"SELECT \" + take + \" \" + columnAliases + \" FROM \" + this._getQualifiedDbTableName(),\n            joinClause,\n            where,\n            orderBy\n        );\n\n        return queryParts.filter((part) => {\n            return part != null && part != \"\";\n        }).join(\" \");\n    };\n\n    date(expression) {\n        return this._sqlizePrimitive(expression.value);\n    }\n\n    descending(propertyAccessor) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" DESC\";\n    }\n\n    endsWith(propertyAccessor, value) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" LIKE \" + this.dataConverter.convertEndsWithString(value);\n    }\n\n    equalTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        if (right === null) {\n            return left + \" IS NULL\";\n        } else {\n            return left + \" = \" + this._sqlizePrimitive(right);\n        }\n    }\n\n    expression(expression) {\n        return expression.value;\n    }\n\n    greaterThan(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" > \" + this._sqlizePrimitive(right);\n    }\n\n    greaterThanOrEqualTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" >= \" + this._sqlizePrimitive(right);\n    }\n\n    include(whereExpression) {\n        return whereExpression;\n    }\n\n    isIn(property, array) {\n        return \"(\" + array.map((value) => {\n            return this.equalTo(property, value);\n        }).join(\" OR \") + \")\";\n    }\n\n    isNotIn(property, array) {\n        return \"(\" + array.map((value) => {\n            return this.notEqual(property, value);\n        }).join(\" AND \") + \")\";\n    }\n\n    lessThan(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" < \" + this._sqlizePrimitive(right);\n    }\n\n    lessThanOrEqualTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        return left + \" <= \" + this._sqlizePrimitive(right);\n    }\n\n    makeColumnAliases(map) {\n        let columns = [];\n\n        map.forEach((table) => {\n            let tableName = table.name;\n\n            table.columns.forEach((column) => {\n                let columnName = column.name;\n\n                columns.push(this._getQualifiedDbTableName() + \".\" + this._escapeIdentifier(columnName) + \" AS \" + this._escapeIdentifier(tableName + \"___\" + columnName));\n            });\n\n        });\n\n        return columns.join(\", \");\n    }\n\n    not(left, right) {\n        return left + \" NOT \" + right;\n    }\n\n    notEqualTo(propertyAccessor, right) {\n        let left = propertyAccessor.value;\n        if (right === null) {\n            return left + \" IS NOT NULL\";\n        } else {\n            return left + \" <> \" + this._sqlizePrimitive(right);\n        }\n    }\n\n    null(expression) {\n        return null;\n    }\n\n    number(expression) {\n        return expression.value;\n    }\n\n    or() {\n        let children = Array.prototype.slice.call(arguments, 0);\n        let result = [];\n        children.forEach((expression, index) => {\n            result.push(expression);\n            if (index !== children.length - 1) {\n                result.push(\" OR \");\n            }\n        });\n\n        let joined = result.join(\"\");\n\n        if (joined === \"\") {\n            return \"\";\n        }\n\n        return \"(\" + joined + \")\";\n    }\n\n    orderBy() {\n        let result = Array.prototype.slice.call(arguments, 0).join(\", \");\n        if (!result) {\n            return \"\";\n        }\n\n        return \"ORDER BY \" + result;\n    }\n\n    property(expression) {\n        let property = expression.value;\n        return property;\n    }\n\n    propertyAccess(tableMetaData, property) {\n        let propertyData = tableMetaData.navigationProperties && tableMetaData.navigationProperties[property] || null;\n        let propertyTable = propertyData && propertyData.table || null;\n        let currentTableName = this.currentNavigationTable.name;\n\n        let navigationProperties = null;\n\n        if (propertyTable) {\n            if (this.isParsingInclude) {\n                this.tableTypes.set(propertyTable.name, propertyTable);\n            }\n            this._addJoinClause(propertyData.joinClause);\n            this.currentNavigationTable = propertyTable;\n            navigationProperties = this._getNavigationProperties(this.edm, propertyTable);\n        }\n\n        return {\n            table: propertyTable,\n            value: this._writeTableProperty(currentTableName, property),\n            navigationProperties: navigationProperties\n        };\n    }\n\n    queryable(property, expression) {\n        let table = property.table;\n        let visitor = new Visitor(table.name, this.edm);\n\n        return visitor.parse(expression);\n    };\n\n    skip(value) {\n        return \"OFFSET \" + value;\n    }\n\n    startsWith(propertyAccessor, value) {\n        let namespace = propertyAccessor.value;\n        let newValue = this._sqlizePrimitive(value);\n        newValue = value.substring(1, value.length - 1);\n\n        return namespace + \" LIKE \" + this.dataConverter.convertStartsWithString(value);\n    }\n\n    string(expression) {\n        return expression.value;\n    }\n\n    substringOf(propertyAccessor, value) {\n        let namespace = propertyAccessor.value;\n        return namespace + \" LIKE \" + this.dataConverter.convertContainsString(value);\n    }\n\n    take(value) {\n        if (value === Infinity) {\n            return \"\";\n        } else {\n            return `TOP(${value})`;\n        }\n    }\n\n    type(type) {\n        this.currentNavigationTable = this.table;\n        let navigationProperties = this._getNavigationProperties(this.edm, this.table)\n\n        return {\n            table: this.table,\n            value: \"\",\n            navigationProperties: navigationProperties\n        };\n    }\n\n    where(expression) {\n        if (!expression) {\n            return \"\";\n        }\n        return \"WHERE \" + this[\"and\"].apply(this, arguments);\n    }\n\n}\n"]}