{"version":3,"sources":["../../src/meta/Provider.js"],"names":["Provider","user","metaTable","metaDatabase","provider","table","decorators","obj","method","args","result","apply","Promise","resolve","queryable","query","getQuery","innerQueries","where","getMatchingNodes","type","nodeName","reduce","queryableExpression","value","getTable","previousQueryable","promise","decorator","then","options","decoratorOptions","name","_invokeMethodAsync","modifiedQuery","select","orderBy","skip","take","_refineInnerQueriesAsync","_refineQueryableAsync","toArrayAsync","results","previousResults","Array","isArray","length","toArrayWithCountAsync","countAsync"],"mappings":"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","file":"Provider.js","sourcesContent":["import { Queryable, ValueExpression } from \"queryablejs\";\n\nexport default class Provider {\n    constructor(user, metaTable, metaDatabase) {\n        this.metaTable = metaTable;\n        this.metaDatabase = metaDatabase;\n        this.provider = metaTable.table.provider;\n        this.decorators = metaTable.decorators;\n        this.user = user;\n    }\n\n    _invokeMethodAsync(obj, method, args = []) {\n        if (obj != null && typeof obj[method] === \"function\") {\n            var result = obj[method].apply(obj, args);\n\n            if (!(result instanceof Promise)) {\n                result = Promise.resolve(result);\n            }\n\n            return result;\n        }\n\n        return Promise.resolve();\n    }\n\n    _refineInnerQueriesAsync(queryable) {\n        let user = this.user;\n        let query = queryable.getQuery();\n        //let innerQueries = query.where.getMatchingNodes(new ValueExpression(\"queryable\"));\n        let innerQueries = query.where.getMatchingNodes({type: \"value\", nodeName: \"queryable\"});\n\n        return innerQueries.reduce((queryableExpression) => {\n            let query = queryableExpression.value;\n            let queryable = new Queryable(query.type, query);\n            let metaTable = this.metaDatabase.getTable(query.type);\n            let previousQueryable = queryable;\n\n            return this.decorators.reduce((promise, decorator) => {\n                return promise.then((queryable) => {\n                    previousQueryable = queryable;\n\n                    let options = metaTable.decoratorOptions[decorator.name];\n                    let result = this._invokeMethodAsync(decorator, \"refineQueryableAsync\", [user, queryable, options])\n\n                    if (result == null) {\n                        result = queryable;\n                    }\n\n                    if (!(result instanceof Promise)) {\n                        return Promise.resolve(result);\n                    }\n\n                    return result;\n                }).then((queryable) => {\n                    if (!(queryable instanceof Queryable)) {\n                        return previousQueryable;\n                    }\n\n                    let modifiedQuery = query.getQuery();\n                    query.select = modifiedQuery.select;\n                    query.where = modifiedQuery.where;\n                    query.orderBy = modifiedQuery.orderBy;\n                    query.skip = modifiedQuery.skip;\n                    query.take = modifiedQuery.take;\n                    query.type = modifiedQuery.type;\n\n                    return queryable;\n                });\n            }, Promise.resolve(queryable));\n\n\n\n        }, Queryable).then(() => {\n            return queryable;\n        });\n    }\n\n    _refineQueryableAsync(queryable) {\n        let user = this.user;\n\n        return this._refineInnerQueriesAsync(queryable).then((queryable) => {\n            let previousQueryable = queryable;\n\n            return this.decorators.reduce((promise, decorator) => {\n                return promise.then((queryable) => {\n                    previousQueryable = queryable;\n\n                    let options = this.metaTable.decoratorOptions[decorator.name];\n                    let result = this._invokeMethodAsync(decorator, \"refineQueryableAsync\", [user, queryable, options]);\n\n                    if (result == null) {\n                        result = queryable;\n                    }\n\n                    if (!(result instanceof Promise)) {\n                        return Promise.resolve(result);\n                    }\n\n                    return result;\n                }).then((queryable) => {\n                    if (!(queryable instanceof Queryable)) {\n                        return previousQueryable;\n                    }\n                    return queryable;\n                });\n            }, Promise.resolve(queryable));\n\n        });\n    }\n\n    toArrayAsync(queryable) {\n        let user = this.user;\n\n        return this._refineQueryableAsync(queryable).then((queryable) => {\n            return this.provider.toArrayAsync(queryable);\n        }).then((results) => {\n            // We need to save the previous results just in case the decorator doesn't implement\n            // the life-cycle or it returns something that isn't an array.\n            let previousResults = results;\n\n            return this.decorators.reduce((promise, decorator) => {\n                return promise.then((results) => {\n                    if (!Array.isArray(results) || results.length !== previousResults.length) {\n                        results = previousResults;\n                    }\n\n                    previousResults = results;\n\n                    this._invokeMethodAsync(decorator, \"mapAsync\", [results]);\n                });\n                \n            }, Promise.resolve(results));\n        });\n    }\n\n    toArrayWithCountAsync(queryable) {\n        let user = this.user;\n\n        return this._refineQueryableAsync(queryable).then((queryable) => {\n            return this.provider.toArrayWithCountAsync(queryable);\n        });\n    }\n\n    countAsync(queryable) {\n        let user = this.user;\n\n        return this._refineQueryableAsync(queryable).then((queryable) => {\n            return this.provider.countAsync(queryable);\n        });\n    }\n}"]}