{"version":3,"sources":["../../src/glassDoor/GlassExpressRouter.js"],"names":["app","pane","enabled","handler","Router","use","req","res","next","status","send","json","user","param","model","table","metaDatabase","getTable","version","id","intId","parseInt","getEntityByIdAsync","then","result","entity","catch","e","name","handleAdd","addEntityAsync","handleQuery","query","queryable","asQueryable","merge","toArrayAsync","get","q","fileType","set","getFileWriteStreamByIdAsync","params","stream","post","body","updateEntityAsync","busboy","on","fieldname","file","filename","encoding","mimetype","data","write","end","delete","removeEntityAsync","removeFileByIdAsync","edm"],"mappings":"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","file":"GlassExpressRouter.js","sourcesContent":["import express from \"express\";\nimport bodyParser from \"body-parser\";\nimport busboy from \"connect-busboy\";\nimport Queryable from \"queryablejs\";\n\nexport default class {\n    constructor(app, pane){\n        this.enabled = true;\n        this.pane = pane;\n        this.app = app;\n    }\n\n    // NOTE: sub-apps and routers can not be removed from an Express app stack,\n    // so we wrap the router and use some middleware to short-circuit\n    // requests to things we wish we could remove.\n    dispose() {\n        this.enabled = false;\n    }\n\n    attach() {\n        let handler = express.Router();\n        handler.use((req, res, next) => {\n            if (this.enabled) {\n                next();\n            } else {\n                res.status(500).send(\"This API is no longer valid\");\n            }\n        });\n        handler.use(bodyParser.json());\n        handler.use(busboy());\n\n        handler.use((req, res, next) => {\n            // add the user to req\n            // TODO: actually add the user to req\n            req.user = {};\n            next();\n        });\n\n        handler.param(\"model\", (req, res, next, model) => {\n            let table = this.pane.metaDatabase.getTable(model);\n            if (table) {\n                req.table = table;\n                next();\n            } else {\n                res.status(500).send(`Unknown model: ${model}`);\n            }\n        });\n\n        handler.param(\"version\", (req, res, next, version) => {\n            // verify version is valid for given model\n            // else throw\n            next();\n        });\n\n        handler.param(\"id\", (req, res, next, id) => {\n            let intId = parseInt(id, 10);\n\n            req.table.getEntityByIdAsync(user, id).then((result) => {\n                req.entity = result;\n                next();\n            }).catch((e) => {\n                res.status(404).send(`Could not find id:${id} on ${table.name}`);                \n            });\n        });\n\n        let handleAdd = function(entity, req, res, next) {\n            req.table.addEntityAsync(entity).then((result) => {\n                res.status(201).send(result);\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        }\n\n        let handleQuery = function(query, req, res, next) {\n            var queryable = new Queryable(\"\", query);\n            req.table.asQueryable(req.user).merge(queryable).toArrayAsync().then((result) => {\n                res.send(result);\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        }\n\n        // GET by ID\n        handler.get(\"/:model/:version/:id\", (req, res, next) => {\n            res.send(req.entity);\n        });\n        \n        // GET query\n        handler.get(\"/:model/:version\", (req, res, next) => {\n            handleQuery(req.query.q, req, res, next);\n        });\n\n        // GET file\n        // TODO: what about MIME types and whatnot?\n        handler.get(\"/:model/:version/:id/file\", (req, res, next) => {\n            // by convention, we can have a \"fileType\" property on any\n            // entity that wants to make such known to a client.\n            if (req.entity.fileType) {\n                res.set(req.entity.fileType);\n            }            \n            req.table.getFileWriteStreamByIdAsync(req.user, req.params.id).then((stream) => {\n                res.send(stream);\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        });\n\n        // POST new or query\n        handler.post(\"/:model/:version\", (req, res, next) => {\n            // cleverness award\n            // TODO: too clever?\n            (req.get(\"X-Query\") ? handleQuery : handleAdd)(req.body, req, res, next);\n        });\n\n        // POST update\n        handler.post(\":/model/:version/:id\", (req, res, next) => {\n            req.table.updateEntityAsync(req.user, req.entity, req.body).then((result) => {\n                res.send(result);\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        });\n\n        // POST file\n        handler.post(\":/model/:version/:id/file\", (req, res, next) => {\n            if (!req.busboy) {\n                res.status(500).send(\"No file found\");\n            }\n            req.table.getFileWriteStreamByIdAsync(req.user, req.params.id).then((stream) => {\n                req.busboy.on('file', (fieldname, file, filename, encoding, mimetype) => {\n                    file.on('data', (data) => {\n                        stream.write(data);\n                    });\n                    file.on('end', () => {\n                        stream.end();\n                        res.status(200).end();\n                    });\n                });\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        });\n\n        // DELETE entity\n        handler.delete(\":/model/:version/:id\", (req, res, next) => {\n            req.table.removeEntityAsync(req.user, req.entity).then((result) => {\n                res.status(200).end();\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        });\n\n        // DELETE file\n        handler.delete(\":/model/:version/:id/file\", (req, res, next) => {\n            req.table.removeFileByIdAsync(req.user, req.params.id).then((result) => {\n                res.status(200).end();\n            }).catch((e) => {\n                res.status(500).send(e);\n            });\n        });\n\n        this.app.use(this.pane.edm.name, handler);\n    }\n\n\n}"]}