{"version":3,"sources":["../src/MetaTable.js"],"names":["defaultDecorators","name","edm","table","decorators","MetaTable","edmTable","_getEdmTable","decoratorOptions","filter","decorator","findIndex","tableDecorator","options","user","entity","_invokeMethodOnDecoratorsAsync","then","Error","_invokeMethodWithRecoveryOnDecoratorsAsync","delta","reduce","promise","_invokeMethodWithRecoveryAsync","Promise","resolve","tables","find","obj","method","args","result","apply","catch","eror","customArgs","slice","push","_invokeMethodAsync","Object","freeze","_assertUser","_prepareEntityToBeAddedAsync","_validateEntityToBeAddedAsync","addEntityAsync","_entityAddedAsync","provider","getQueryProvider","queryable","_approveEntityToBeRemovedAsync","removeEntityAsync","_entityRemovedAsync","updatedEntity","_prepareEntityToBeUpdatedAsync","_validateEntityToBeUpdatedAsync","updateEntityAsync","_entityUpdatedAsync"],"mappings":"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","file":"MetaTable.js","sourcesContent":["import Table from \"./sqlite/Table\"\nimport MetaProvider from \"./MetaProvider\";\nimport {Queryable} from \"queryablejs\";\nimport User from \"./User\";\n\nconst defaultDecorators = {\n    name: null,\n    edm: null,\n    table: null,\n    decorators: []\n};\n\nexport default class MetaTable {\n    constructor({ table = null, decorators = [] } = {}) {\n        this.table = table;\n        this.name = table.name;\n        this.edm = table.edm;\n        this.edmTable = this._getEdmTable(this.name);\n        this.decoratorOptions = {};\n        this.decorators = decorators.filter((decorator) => {\n            let decorators = this.edmTable.decorators || [];\n\n            return decorators.findIndex((tableDecorator) => {\n                this.decoratorOptions[tableDecorator.name] = tableDecorator.options;\n                return tableDecorator.name === decorator.name\n            }) > -1;\n        });\n    }\n\n    _approveEntityToBeRemovedAsync(user, entity) {\n        return this._invokeMethodOnDecoratorsAsync(\"approveEntityToBeRemovedAsync\", [user, entity]).then(() => {\n            return entity;\n        });\n    }\n\n    _assertUser(user) {\n        if (!(user instanceof User)) {\n            throw new Error(\"Illegal Argument Exception: user needs to be an instance of User.\");\n        }\n    }\n\n    _entityAddedAsync(user, entity) {\n        return this._invokeMethodWithRecoveryOnDecoratorsAsync(\"entityAddedAsync\", [user, entity]).then(() => {\n            return entity;\n        });\n    }\n\n    _entityRemovedAsync(user, entity) {\n        return this._invokeMethodWithRecoveryOnDecoratorsAsync(\"entityRemovedAsync\", [user, entity]).then(() => {\n            return entity;\n        });\n    }\n\n    _entityUpdatedAsync(user, entity, delta) {\n        return this.decorators.reduce((promise, decorator) => {\n            return promise.then(() => {\n                let options = this.decoratorOptions[decorator.name];\n                return this._invokeMethodWithRecoveryAsync(decorator, \"entityUpdatedAsync\", [user, entity, delta, options]);\n            });\n        }, Promise.resolve());\n    }\n\n    _getEdmTable(name) {\n        return this.edm.tables.find((table) => {\n            return table.name === name;\n        });\n    }\n\n    _invokeMethodAsync(obj, method, args = []) {\n        if (obj != null && typeof obj[method] === \"function\") {\n            var result = obj[method].apply(obj, args);\n\n            if (!(result instanceof Promise)) {\n                result = Promise.resolve(result);\n            }\n\n            return result;\n        }\n\n        return Promise.resolve();\n    }\n\n    _invokeMethodWithRecoveryAsync(obj, method, args = []) {\n        let promise = Promise.resolve();\n\n        if (obj != null && typeof obj[method] === \"function\") {\n            promise = obj[method].apply(obj, args);\n\n            if (!(promise instanceof Promise)) {\n                promise = Promise.resolve(promise);\n            }\n        }\n\n        return promise.catch((eror) => {\n            // Log error.\n            return null\n        });\n    }\n\n    _invokeMethodOnDecoratorsAsync(method, args) {\n        return this.decorators.reduce((promise, decorator) => {\n            return promise.then(() => {\n                let options = this.decoratorOptions[decorator.name];\n                let customArgs = args.slice();\n                customArgs.push(options);\n\n                return this._invokeMethodAsync(decorator, method, customArgs);\n            });\n        }, Promise.resolve());\n    }\n\n    _invokeMethodWithRecoveryOnDecoratorsAsync(method, args) {\n        return this.decorators.reduce((promise, decorator) => {\n            return promise.then(() => {\n                let options = this.decoratorOptions[decorator.name];\n                let customArgs = args.slice();\n                customArgs.push(options);\n\n                return this._invokeMethodWithRecoveryAsync(decorator, method, customArgs);\n            });\n        }, Promise.resolve());\n    }\n\n    _prepareEntityToBeAddedAsync(user, entity) {\n        return this._invokeMethodOnDecoratorsAsync(\"prepareEntityToBeAddedAsync\", [user, entity]);\n    }\n\n    _prepareEntityToBeUpdatedAsync(user, entity, delta) {\n        return this.decorators.reduce((promise, decorator) => {\n            return promise.then((delta) => {\n                let options = this.decoratorOptions[decorator.name];\n                return this._invokeMethodAsync(decorator, \"prepareEntityToBeUpdatedAsync\", [user, entity, delta, options]);\n            });\n        }, Promise.resolve(delta))\n    }\n\n    _validateEntityToBeAddedAsync(user, entity) {\n        Object.freeze(entity);\n\n        return this._invokeMethodOnDecoratorsAsync(\"validateEntityToBeAddedAsync\", [user, entity]).then(() => {\n            return entity;\n        });\n    }\n\n    _validateEntityToBeUpdatedAsync(user, entity, delta) {\n        Object.freeze(delta);\n\n        return this.decorators.reduce((promise, decorator) => {\n            let options = this.decoratorOptions[decorator.name];\n            return promise.then(() => {\n                return this._invokeMethodAsync(decorator, \"validateEntityToBeUpdatedAsync\", [user, entity, delta, options]);\n            });\n        }, Promise.resolve()).then(() => {\n            return delta;\n        });\n    }\n\n    addEntityAsync(user, entity) {\n        this._assertUser(user);\n\n        return this._prepareEntityToBeAddedAsync(user, entity).then(() => {\n            return this._validateEntityToBeAddedAsync(user, entity);\n        }).then(() => {\n            return this.table.addEntityAsync(entity);\n        }).then((entity) => {\n            return this._entityAddedAsync(user, entity);\n        });\n    }\n\n    asQueryable(user) {\n        this._assertUser(user);\n\n        let provider = this.getQueryProvider(user);\n        let queryable = new Queryable();\n\n        queryable.provider = provider;\n\n        return queryable;\n    }\n\n    getQueryProvider(user) {\n        this._assertUser(user);\n\n        return new MetaProvider(user, this);\n    }\n\n    removeEntityAsync(user, entity) {\n        this._assertUser(user);\n\n        Object.freeze(entity);\n        return this._approveEntityToBeRemovedAsync(user, entity).then(() => {\n            return this.table.removeEntityAsync(entity);\n        }).then(() => {\n            return this._entityRemovedAsync(user, entity);\n        });\n    }\n\n    updateEntityAsync(user, entity, delta) {\n        this._assertUser(user);\n\n        Object.freeze(entity);\n        let updatedEntity;\n\n        return this._prepareEntityToBeUpdatedAsync(user, entity, delta).then((delta) => {\n            return this._validateEntityToBeUpdatedAsync(user, entity, delta);\n        }).then((delta) => {\n            return this.table.updateEntityAsync(user, entity, delta).then((entity) => {\n                updatedEntity = entity;\n                return delta;\n            });\n        }).then((delta) => {\n            return this._entityUpdatedAsync(updatedEntity, delta);\n        }).then(() => {\n            return updatedEntity;\n        });\n    }\n\n}"]}